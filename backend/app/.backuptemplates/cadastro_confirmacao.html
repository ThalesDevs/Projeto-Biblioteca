<!-- templates/cadastro_confirmacao.html -->
{% extends "base.html" %}

{% block title %}Cadastro{% endblock %}

{% block content %}
<div style="max-width: 500px; margin: 50px auto; padding: 20px;">
    <h2>Cadastro de Usuário</h2>
    
    <div id="mensagem" style="display: none; padding: 15px; border-radius: 5px; margin-bottom: 20px;"></div>
    
    <form id="formCadastro" onsubmit="cadastrarUsuario(event)">
        <div style="margin-bottom: 15px;">
            <label for="nome">Nome completo:</label><br>
            <input type="text" id="nome" name="nome" required minlength="2" maxlength="100"
                   style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label for="email">E-mail:</label><br>
            <input type="email" id="email" name="email" required
                   style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label for="senha">Senha (mínimo 6 caracteres):</label><br>
            <input type="password" id="senha" name="senha" required minlength="6"
                   style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label for="confirmarSenha">Confirme a senha:</label><br>
            <input type="password" id="confirmarSenha" name="confirmarSenha" required minlength="6"
                   style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px;">
        </div>

        <button type="submit" id="btnCadastrar"
                style="width: 100%; background-color: #28a745; color: white; padding: 12px; 
                       border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
            Cadastrar
        </button>
    </form>

    <p style="margin-top: 20px; text-align: center;">
        Já tem uma conta? <a href="/auth/login">Faça login aqui</a>
    </p>
</div>

<script>
async function cadastrarUsuario(event) {
    event.preventDefault();
    
    const btnCadastrar = document.getElementById('btnCadastrar');
    const mensagem = document.getElementById('mensagem');
    
    // Dados do formulário
    const dados = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        senha: document.getElementById('senha').value,
        confirmar_senha: document.getElementById('confirmarSenha').value
    };
    
    // Validar senhas
    if (dados.senha !== dados.confirmar_senha) {
        mostrarMensagem('Senhas não conferem!', 'erro');
        return;
    }
    
    // Desabilitar botão
    btnCadastrar.disabled = true;
    btnCadastrar.textContent = 'Cadastrando...';
    
    try {
        const response = await fetch('/auth/cadastro-com-confirmacao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (result.sucesso) {
            mostrarMensagem(result.mensagem, 'sucesso');
            document.getElementById('formCadastro').reset();
            
            // Redirecionar após 3 segundos
            setTimeout(() => {
                window.location.href = `/auth/aguardando-confirmacao?email=${encodeURIComponent(dados.email)}`;
            }, 3000);
        } else {
            mostrarMensagem(result.mensagem, 'erro');
        }
    } catch (error) {
        mostrarMensagem('Erro ao realizar cadastro. Tente novamente.', 'erro');
    } finally {
        btnCadastrar.disabled = false;
        btnCadastrar.textContent = 'Cadastrar';
    }
}

function mostrarMensagem(texto, tipo) {
    const mensagem = document.getElementById('mensagem');
    mensagem.textContent = texto;
    mensagem.style.display = 'block';
    
    if (tipo === 'sucesso') {
        mensagem.style.backgroundColor = '#d4edda';
        mensagem.style.color = '#155724';
    } else {
        mensagem.style.backgroundColor = '#f8d7da';
        mensagem.style.color = '#721c24';
    }
    
    // Auto-ocultar após 5 segundos
    setTimeout(() => {
        mensagem.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
